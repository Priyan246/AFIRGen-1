<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' http://localhost:8000 https://*; img-src 'self' data: blob:; frame-ancestors 'none'; base-uri 'self'; form-action 'self';">
    <title>CSP Test - AFIRGen</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
        #console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>Content Security Policy Test</h1>
    <p>This page tests the CSP configuration for AFIRGen. Check the console for detailed results.</p>

    <div class="test-section">
        <div class="test-title">CSP Configuration</div>
        <div id="csp-config" class="test-result info">Loading...</div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 1: Inline Script (Should Work - 'unsafe-inline' allowed)</div>
        <div id="test1-result" class="test-result">Pending...</div>
        <button onclick="runTest1()">Run Test 1</button>
    </div>

    <div class="test-section">
        <div class="test-title">Test 2: External Script from Same Origin (Should Work)</div>
        <div id="test2-result" class="test-result">Pending...</div>
        <button onclick="runTest2()">Run Test 2</button>
    </div>

    <div class="test-section">
        <div class="test-title">Test 3: Inline Style (Should Work - 'unsafe-inline' allowed)</div>
        <div id="test3-result" class="test-result">Pending...</div>
        <button onclick="runTest3()">Run Test 3</button>
    </div>

    <div class="test-section">
        <div class="test-title">Test 4: Image from Data URI (Should Work)</div>
        <div id="test4-result" class="test-result">Pending...</div>
        <button onclick="runTest4()">Run Test 4</button>
    </div>

    <div class="test-section">
        <div class="test-title">Test 5: Fetch to Same Origin (Should Work)</div>
        <div id="test5-result" class="test-result">Pending...</div>
        <button onclick="runTest5()">Run Test 5</button>
    </div>

    <div class="test-section">
        <div class="test-title">Console Output</div>
        <div id="console-output"></div>
    </div>

    <script src="lib/dompurify.min.js"></script>
    <script src="js/security.js"></script>
    <script>
        // Capture console output
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addToConsole(type, ...args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput.textContent += `[${type.toUpperCase()}] ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            addToConsole('log', ...args);
            originalLog.apply(console, args);
        };

        console.error = function(...args) {
            addToConsole('error', ...args);
            originalError.apply(console, args);
        };

        console.warn = function(...args) {
            addToConsole('warn', ...args);
            originalWarn.apply(console, args);
        };

        // Display CSP configuration
        function displayCSPConfig() {
            const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            const configDiv = document.getElementById('csp-config');
            
            if (cspMeta) {
                const content = cspMeta.getAttribute('content');
                const directives = content.split(';').map(d => d.trim()).filter(d => d);
                
                let html = '<strong>Active CSP Directives:</strong><br>';
                directives.forEach(directive => {
                    html += `• ${directive}<br>`;
                });
                
                configDiv.innerHTML = html;
                console.log('CSP Configuration loaded successfully');
            } else {
                configDiv.innerHTML = '<strong>Error:</strong> No CSP meta tag found!';
                configDiv.className = 'test-result fail';
                console.error('CSP meta tag not found');
            }
        }

        // Test 1: Inline script
        function runTest1() {
            const resultDiv = document.getElementById('test1-result');
            try {
                // This should work because 'unsafe-inline' is allowed
                eval('console.log("Test 1: Inline script executed successfully")');
                resultDiv.textContent = '✓ PASS: Inline script executed (unsafe-inline allowed)';
                resultDiv.className = 'test-result pass';
            } catch (e) {
                resultDiv.textContent = '✗ FAIL: ' + e.message;
                resultDiv.className = 'test-result fail';
                console.error('Test 1 failed:', e);
            }
        }

        // Test 2: External script from same origin
        function runTest2() {
            const resultDiv = document.getElementById('test2-result');
            const script = document.createElement('script');
            script.src = 'js/security.js';
            
            script.onload = function() {
                resultDiv.textContent = '✓ PASS: External script from same origin loaded successfully';
                resultDiv.className = 'test-result pass';
                console.log('Test 2: External script loaded');
            };
            
            script.onerror = function() {
                resultDiv.textContent = '✗ FAIL: External script blocked by CSP';
                resultDiv.className = 'test-result fail';
                console.error('Test 2 failed: Script blocked');
            };
            
            // Don't actually append to avoid duplicate script
            resultDiv.textContent = '✓ PASS: External script from same origin is allowed (already loaded)';
            resultDiv.className = 'test-result pass';
            console.log('Test 2: External script from same origin is allowed');
        }

        // Test 3: Inline style
        function runTest3() {
            const resultDiv = document.getElementById('test3-result');
            try {
                const testDiv = document.createElement('div');
                testDiv.style.cssText = 'color: green; font-weight: bold;';
                testDiv.textContent = 'Styled text';
                
                resultDiv.textContent = '✓ PASS: Inline styles applied successfully';
                resultDiv.className = 'test-result pass';
                console.log('Test 3: Inline styles work');
            } catch (e) {
                resultDiv.textContent = '✗ FAIL: ' + e.message;
                resultDiv.className = 'test-result fail';
                console.error('Test 3 failed:', e);
            }
        }

        // Test 4: Image from data URI
        function runTest4() {
            const resultDiv = document.getElementById('test4-result');
            const img = new Image();
            
            // 1x1 transparent PNG
            img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
            
            img.onload = function() {
                resultDiv.textContent = '✓ PASS: Image from data URI loaded successfully';
                resultDiv.className = 'test-result pass';
                console.log('Test 4: Data URI image loaded');
            };
            
            img.onerror = function() {
                resultDiv.textContent = '✗ FAIL: Image from data URI blocked by CSP';
                resultDiv.className = 'test-result fail';
                console.error('Test 4 failed: Data URI blocked');
            };
        }

        // Test 5: Fetch to same origin
        function runTest5() {
            const resultDiv = document.getElementById('test5-result');
            
            fetch('index.html')
                .then(response => {
                    if (response.ok) {
                        resultDiv.textContent = '✓ PASS: Fetch to same origin successful';
                        resultDiv.className = 'test-result pass';
                        console.log('Test 5: Fetch to same origin works');
                    } else {
                        throw new Error('Response not OK');
                    }
                })
                .catch(error => {
                    resultDiv.textContent = '✗ FAIL: Fetch blocked by CSP - ' + error.message;
                    resultDiv.className = 'test-result fail';
                    console.error('Test 5 failed:', error);
                });
        }

        // Listen for CSP violations
        document.addEventListener('securitypolicyviolation', function(e) {
            console.error('CSP Violation detected:', {
                blockedURI: e.blockedURI,
                violatedDirective: e.violatedDirective,
                effectiveDirective: e.effectiveDirective
            });
        });

        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            displayCSPConfig();
            console.log('CSP Test page loaded. Click buttons to run tests.');
        });
    </script>
</body>
</html>
